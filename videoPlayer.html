<!DOCTYPE html>
<html>

<head>
	<link href="https://vjs.zencdn.net/7.18.1/video-js.css" rel="stylesheet" />
	<script src="https://vjs.zencdn.net/7.18.1/video.min.js"></script>
	<script src="js/jquery-3.3.1.min.js"></script>
	<script src="js/js-yaml.min.js"></script>
	<script src="js/visione.js"></script>

	<!-- If you'd like to support IE8 (for Video.js versions prior to v7) -->
	<!-- <script src="https://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.min.js"></script> -->
</head>

<body>
	<script type="text/javascript">

		function checkQA() {
			let isQA = localStorage.getItem('taskType') === 'qa' ? true : false;

			if (isQA)
				submitQA();
			return isQA;
		}

		$.urlParam = function (name) {
			var results = new RegExp('[\?&]' + name + '=([^&#]*)')
				.exec(window.location.href);
			return results[1] || 0;
		}

		function submitAtCurrentPlayTime() {
			myPlayer.pause();
			var whereYouAt = myPlayer.currentTime();
			videoid = $.urlParam('videoid');
			if (submitAlert()) {
				res = submitAtTime(videoid, whereYouAt);
				console.log(res);
				alert('Server response: ' + res);
			}
		}
	</script>

	<div id="videoDiv">
		<video id="vbsvideo" class="video-js" controls preload="auto" width="960" height="640" data-setup="{}">
			<p class="vjs-no-js">
				To view this video please enable JavaScript, and consider upgrading to a
				web browser that
				<a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
			</p>
		</video>
	</div>

	<style>
		#videoDiv {
			display: flex;
			justify-content: center;
			/* canh ngang */
			align-items: center;
			/* canh dọc */
			background: #f9f9f9;
			/* tùy chọn */
		}
	</style>

	<!-- Hiển thị thông tin frame -->
	<div id="frameInfo"
		style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; text-align: center;">
		<div style="font-size: 16px; font-weight: bold; color: #333;">
			<span id="currentTime">Time: 0</span> |
			<span id="currentFrame">Frame: 0</span>
		</div>
		<!-- <div style="font-size: 14px; color: #666; margin-top: 5px;">
			<span id="originalFrame">Original Frame ID: </span>
		</div>
		<div style="font-size: 12px; color: #888; margin-top: 3px;">
			<span id="frameRate">Frame Rate: 60 fps</span> |
			<span id="formula">Formula: frame = 60 × time</span>
		</div> -->
	</div>

	<script type="text/javascript">
		var myPlayer;
		var videoFPS = 60;

		function getVideoId() {
			const urlParam = $.urlParam("url");
			if (!urlParam) return null;
			return urlParam.split("/").pop();   // => L22_V030.mp4
		}

		function getTime(seconds) {
			const min = Math.floor(seconds / 60);
			const sec = Math.floor(seconds % 60);
			return min + ":" + (sec < 10 ? "0" + sec : sec);
		}

		async function fetchFPS(videoid) {
			try {
				let res = await fetch("http://14.225.241.236:8000/video/fps/" + videoid);
				let data = await res.json();
				if (data) {
					videoFPS = data;
					console.log("✅ FPS fetched from API:", videoFPS);
				}
			} catch (err) {
				console.error("❌ Error fetching FPS:", err);
			}
		}

		function timeToFrame(time) {
			return Math.round(videoFPS * time);
		}

		function updateFrameInfo() {
			if (myPlayer) {
				var currentTime = myPlayer.currentTime();
				var currentFrame = timeToFrame(currentTime);

				document.getElementById('currentTime').textContent = 'Time: ' + getTime(currentTime.toFixed(0)) + '';
				document.getElementById('currentFrame').textContent = 'Frame: ' + currentFrame;
			}
		}

		async function loadPage() {
			let url = $.urlParam('url');
			let t = $.urlParam('t');
			let videoid = getVideoId();
			
			if (videoid) {
				document.title = videoid;
				await fetchFPS(videoid);
			}

			myPlayer = videojs('vbsvideo');
			myPlayer.src({ type: "video/mp4", src: url });
			myPlayer.currentTime(t || 0);
			myPlayer.muted(true);
			myPlayer.play();

			// update khi video chạy
			myPlayer.on('timeupdate', updateFrameInfo);
			myPlayer.on('seeked', updateFrameInfo);
			myPlayer.on('loadedmetadata', updateFrameInfo);
		}

		loadPage();

		document.addEventListener("keydown", function (event) {
			if (!myPlayer) return;

			switch (event.code) {
				case "Space":
					event.preventDefault();
					if (myPlayer.paused()) {
						myPlayer.play();
					} else {
						myPlayer.pause();
					}
					break;

				case "ArrowRight":
					event.preventDefault();
					myPlayer.currentTime(myPlayer.currentTime() + 5);
					break;

				case "ArrowLeft":
					event.preventDefault();
					myPlayer.currentTime(myPlayer.currentTime() - 5);
					break;
			}
		});
	</script>
	<div style="margin-top: 10px; text-align: center;">
		<!-- <button id="submit" class="btn btn-warning btn-sm" title="Submit result at current play time"
			onclick="if (!checkQA()) submitAtCurrentPlayTime();">
			<i class="fa fa-play"> Submit</i></button>

		<button id="gotoOriginal" class="btn btn-info btn-sm" style="margin-left: 10px;"
			title="Go to original frame time" onclick="gotoOriginalFrame();">
			<i class="fa fa-undo"> Go to Original Frame</i></button> -->
	</div>
</body>

</html>